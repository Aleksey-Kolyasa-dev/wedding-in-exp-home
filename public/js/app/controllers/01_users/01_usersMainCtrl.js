define(["angular"],function(e){"use strict";function r(e,r,o,n,t,i,s,a,c,u,l){e.$on("logout",function(){i.localStorage.userToken&&i.localStorage.removeItem("userToken");var r={_id:e.currentUser._id,name:e.currentUser.name,isLogged:!1,isAuth:!1};u._ajaxRequest("PUT",null,r,"/logout").catch(function(e){c.error("USER LOGOUT AJAX FAILED!"),t.error("USER LOGOUT AJAX FAILED!",e)})}),e.$on("registrationSuccess",function(r,o){e.$broadcast("doLogin",o)})}function o(r,o,n,t,i,s,a,c,u){if(r.doLogin=function(e){if(!e.login||!e.password)throw s.error("ERROR: INVALID LOGIN INPUT!"),new Error("ERROR: INVALID LOGIN INPUT!");var c={login:e.login,password:o.btoa(e.login+e.password)};a._ajaxRequest("POST",null,c,"/login").then(function(e){if(e._id&&e.login&&e.password)e.isAuth&&e.isLogged?(r.$emit("LoggedIn",e),r.user={},u._userToken(e)):i(function(){throw t.path("/start"),s.error("LOGIN FAILED!"),new Error("LOGIN FAILED!")},300);else if("USER"==e.property)throw s.error(e.message),new Error(e.message)},function(e){s.error("ERROR, check and try again!"),n.log(e)}).catch(function(e){s.error("ERROR: LOGIN AJAX failed"),n.warn("ERROR: LOGIN AJAX failed",e)})},r.$on("doLogin",function(e,o){o.login&&o.password&&r.doLogin(o)}),o.localStorage.userToken){var l=e.fromJson(o.localStorage.userToken);if(Date.now()-new Date(l.init)<1728e5){var R={login:l.login,password:o.atob(l.pass).slice(l.login.length)};r.doLogin(R)}else o.localStorage.removeItem("userToken")}r.accessByKey=function(e){var o={key:e};c._ajaxRequest("POST",null,o,"/AccessKey").then(function(e){if(!e._id)throw s.error("PROJECT NOT FOUND!"),new Error("PROJECT NOT FOUND!");r.$emit("AccessApproved",e)}).catch(function(e){s.error("VISITOR ACCESS DENIED!"),n.error("VISITOR ACCESS DENIED!",e)})}}function n(e,r,o,n,t,i,s,a,c){e.doRegister=function(r){if(!(r.login&&r.email&&r.password&&r.confirmPassword&&r.name))throw s.error("ERROR: INVALID REGISTRATION DATA!"),new Error("ERROR: INVALID REGISTRATION DATA!");if(r.password!==r.confirmPassword)throw s.error("ERROR: PASSWORDS NOT COINCIDE!"),new Error("ERROR: PASSWORDS NOT COINCIDE!");var n={login:r.login,password:r.password};r.password=t.btoa(r.login+r.password),a._ajaxRequest("POST",null,r,null).then(function(r){if(r.login)e.user={},e.$emit("registrationSuccess",n),_env()._dev?s.success("NEW USER "+r.name+" REGISTRED!"):s.success("OK");else{if("LOGIN"==r.property)throw s.error(r.message),new Error(r.message);if("EMAIL"==r.property)throw s.error(r.message),new Error(r.message);if("VALIDATION"==r.property)throw s.error(r.message),new Error(r.message)}},function(e){s.error("ERROR, check and try again!"),o.log(e)}).catch(function(e){s.error('ERROR: REGISTER NEW USER "POST" AJAX failed'),o.warn('ERROR: REGISTER NEW USER "POST" AJAX failed',e)})}}function t(e,r,o,n,t,i,s,a,c){e.adminMode=function(){e.currentUser.isAdmin&&(n.path("admin"),e.dynamicBackground="projects_main",e.currentProjectView.mainMenu="main")},e.projectView=function(r){switch(r){case"main":e.currentProjectView.mainMenu=r,e.subView="announcement";break;case"restaurant":case"arrangement":e.currentProjectView.mainMenu=r}},e.subViewShift=function(r){switch(r){case"announcement":case"info":case"reports":case"tasks":e.subView=r}}}r.$inject=["$scope","$rootScope","$http","$interval","$log","$window","$location","$timeout","toastr","UsersResourceService","AppService"],o.$inject=["$scope","$window","$log","$location","$timeout","toastr","UsersResourceService","ResourceService","UserAuthService"],n.$inject=["$scope","$rootScope","$log","$location","$window","$timeout","toastr","UsersResourceService","AppService"],t.$inject=["$scope","$rootScope","$log","$location","$window","$timeout","toastr","UsersResourceService","AppService"];var i=e.module("usersCtrlModule",["wedServices","authServices"]);return i.controller("wedUsersMainCtrl",r),i.controller("loginCtrl",o),i.controller("registrationCtrl",n),i.controller("adminCtrl",t),i});