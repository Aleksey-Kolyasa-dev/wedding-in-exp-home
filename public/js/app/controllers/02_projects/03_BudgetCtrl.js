define(["angular"],function(t){"use strict";function e(e,a,r,n,o,d,i){function u(){var t=e.currentProject;t.budget.budgetNat=t.wedBudget*t.budget.currency,t.budget.total.wedPlanTotalUsd=t.restaurant.total.planTotalUsd+t.arrangement.total.planUsd+t.program.total.planUsd+t.filming.total.planUsd+t.registration.total.planUsd+t.marriage.total.planUsd+t.transport.total.planUsd+t.dress.total.planUsd+t.party.total.planUsd+t.other.total.planUsd,t.budget.total.wedPlanTotalNat=t.budget.total.wedPlanTotalUsd*t.budget.currency,t.budget.total.wedPaidTotalUsd=t.restaurant.total.paidTotalUsd+t.arrangement.total.paidTotalUsd+t.program.total.paidTotalUsd+t.filming.total.paidTotalUsd+t.registration.total.paidTotalUsd+t.marriage.total.paidTotalUsd+t.transport.total.paidTotalUsd+t.dress.total.paidTotalUsd+t.party.total.paidTotalUsd+t.other.total.paidTotalUsd,t.budget.total.wedPaidTotalNat=t.budget.total.wedPaidTotalUsd*t.budget.currency,t.budget.total.wedRestTotalUsd=t.budget.total.wedPlanTotalUsd-t.budget.total.wedPaidTotalUsd,t.budget.total.wedRestTotalNat=t.budget.total.wedRestTotalUsd*t.budget.currency,t.budget.total.wedBudgetRestPlanUsd=t.wedBudget-t.budget.total.wedPlanTotalUsd,t.budget.total.wedBudgetRestPlanNat=t.budget.total.wedBudgetRestPlanUsd*t.budget.currency,t.budget.total.wedBudgetRestFactUsd=t.wedBudget-t.budget.total.wedPaidTotalUsd,t.budget.total.wedBudgetRestFactNat=t.budget.total.wedBudgetRestFactUsd*t.budget.currency,t.budget.total.wedBudgetRestPlanUsd>=.15*t.wedBudget?(e.limitNat="nat-use",e.limitUsd="usd-use"):t.budget.total.wedBudgetRestPlanUsd<.15*t.wedBudget&&t.budget.total.wedBudgetRestPlanUsd>.05*t.wedBudget?(e.limitNat="near-limit",e.limitUsd="near-limit"):(e.limitNat="limit",e.limitUsd="limit"),t.budget.total.wedBudgetRestFactUsd>=.15*t.wedBudget?(e.limitNatFact="nat-use",e.limitUsdFact="usd-use"):t.budget.total.wedBudgetRestFactUsd<.15*t.wedBudget&&t.budget.total.wedBudgetRestFactUsd>.05*t.wedBudget?(e.limitNatFact="near-limit",e.limitUsdFact="near-limit"):(e.limitNatFact="limit",e.limitUsdFact="limit"),"nat-use"==e.limitNat&&"nat-use"==e.limitNatFact&&(e.limitNatBud="nat-use",e.limitUsdBud="usd-use"),"near-limit"!=e.limitNat&&"near-limit"!=e.limitNatFact||(e.limitNatBud="near-limit",e.limitUsdBud="near-limit"),"limit"!=e.limitNat&&"limit"!=e.limitUsdFact||(e.limitNatBud="limit",e.limitUsdBud="limit"),e.budgetBar={plan:t.budget.total.wedBudgetRestPlanUsd/t.wedBudget*100,fact:t.budget.total.wedBudgetRestFactUsd/t.wedBudget*100},e.budgetBar.plan<0&&(e.budgetBar.plan=0),e.budgetBar.plan>35&&(e.barStatePlan="bar-budget-good"),e.budgetBar.plan<=35&&e.budgetBar.plan>20&&(e.barStatePlan="bar-budget-half"),e.budgetBar.plan<=20&&e.budgetBar.plan>5&&(e.barStatePlan="bar-budget-warn"),e.budgetBar.plan<=5&&(e.barStatePlan="bar-budget-danger"),e.budgetBar.fact<0&&(e.budgetBar.fact=0),e.budgetBar.fact>35&&(e.barStateFact="bar-budget-good"),e.budgetBar.fact<=35&&e.budgetBar.fact>20&&(e.barStateFact="bar-budget-half"),e.budgetBar.fact<=20&&e.budgetBar.fact>5&&(e.barStateFact="bar-budget-warn"),e.budgetBar.fact<=5&&(e.barStateFact="bar-budget-danger"),e.currentProject.budget.total=t.budget.total,_env()._dev&&a.log("BUDGET CALCULATION UPDATE")}e.subView="settings",e.budget={},e.limitNat="nat-use",e.limitUsd="usd-use",e.limitNatFact="nat-use",e.limitUsdFact="usd-use",e.limitNatBud="nat-use",e.limitUsdBud="usd-use",e.budgetTotals=e.currentProject.budget.total,e.$on("doBudgetReCalculation",function(){"settings"==e.subView&&u()}),e.budgetChangeTrigger=function(t,a){e.budget.nationalMoney=t,e.budget.currency=a},o(function(){u()},500),e.budgetSettingsApply=function(n){if(!t.isDefined(n.nationalMoney)||!t.isNumber(n.currency))throw r.error("ERROR: budget input data failed"),new Error("ERROR: budget input data failed"+err);n.currency<0&&(n.currency*=-1),0==n.currency&&(n.currency=1),e.currentProject.budget.nationalMoney=n.nationalMoney,e.currentProject.budget.currency=n.currency,e.currentProject.budget.budgetNat=e.currentProject.wedBudget*n.currency,o(function(){u();var t={_id:e.currentProject._id,key:"budget",keyURL:"/budgetDataSave",data:e.currentProject.budget};d._ajaxRequest("PUT",null,t,t.keyURL).then(function(t){_env()._dev?(r.success("budget changed"),e.budget={}):(r.success("OK"),e.budget={})},function(t){throw r.error("ERROR: budget input AJAX failed"),new Error("ERROR: budget input AJAX failed"+t)}).catch(function(t){r.error("ERROR: budget input AJAX failed"),a.error("ERROR: budget input AJAX failed",t)})},200)},e.notesFilter=function(t){if(null==t)return"";var e=t.split("*");return""==e[0]&&e.splice(0,1),e},e.noteSave=function(){var t={_id:e.currentProject._id,key:"budgetNotes",keyURL:"/budgetNotes",data:e.currentProject.budgetNotes};d._ajaxRequest("PUT",null,t,t.keyURL).then(function(t){_env()._dev?r.info("Notes are saved!"):r.info("OK")},function(t){throw r.error("ERROR: Notes AJAX failed"),new Error("ERROR: Notes AJAX failed"+t)}).catch(function(t){r.error("ERROR: Notes AJAX failed"),a.error("ERROR: Notes AJAX failed",t)})},e.projNoteSave=function(){var t={_id:e.currentProject._id,key:"projectNotes",keyURL:"/projectNotes",data:e.currentProject.notes};d._ajaxRequest("PUT",null,t,t.keyURL).then(function(t){_env()._dev?r.info("Notes are saved!"):r.info("OK")},function(t){throw r.error("ERROR: Notes AJAX failed"),new Error("ERROR: Notes AJAX failed"+t)}).catch(function(t){r.error("ERROR: Notes AJAX failed"),a.error("ERROR: Notes AJAX failed",t)})},e.subViewShift=function(n){switch(n){case"settings":e.subView=n,u();break;case"info":case"reports":case"tasks":e.subView=n;break;case"sms":e.subView=n,t.forEach(e.currentUser.smsQty,function(t){t.projectId==e.currentProject._id&&(t.qty=e.currentProject.smsCollection.length,e.newSMS[e.currentProject._id]=0)});var o={_id:e.currentUser._id,arr:e.currentUser.smsQty};i._ajaxRequest("PUT",null,o,"/smsQty").catch(function(t){r.error("ERROR: AJAX ERROR"),a.error("ERROR: AJAX ERROR",t)})}}}function a(e,a,r,n){e.conf={mainProp:"tasks",msgNameBg:"TASKS",msgNameSm:"tasks",title:"СПИСОК ЗАДАЧ",ttlBy:"ЗАДАЧАМ",get addForm(){return"addNew"+this.msgNameSm+"ExpenseForm"},get editForm(){return"edit"+this.msgNameSm+"ExpenseForm"}},e.itemToEdit={},e.newItem={},e.removeTrigger={},e.removeTrigger.status=!1,e.items=e.currentProject[e.conf.mainProp].expCollection,e.addNewExpenseItem=function(o){if(""==o.name||!t.isNumber(o.priority))throw r.error("ERROR: "+e.conf.msgNameSm+"  input check failed"),new Error("ERROR: "+e.conf.msgNameSm+"  input check failed");e.currentProject[e.conf.mainProp].expCollection.push(o),_env()._dev&&a.log("Update PROJECT by "+e.conf.msgNameBg+": reason - ADD "+e.conf.msgNameBg+"  EVENT ");var d={_id:e.currentProject._id,key:e.conf.mainProp,keyURL:"/"+e.conf.mainProp+"DataSave"};d[e.conf.mainProp]=e.currentProject[e.conf.mainProp],n._ajaxRequest("PUT",null,d,d.keyURL).then(function(t){e.newItem={},_env()._dev?r.success("New "+e.conf.msgNameSm+" Item created!"):r.success("OK")},function(t){throw r.error("ERROR: New "+e.conf.msgNameSm+" Item AJAX failed"),new Error("ERROR: New "+e.conf.msgNameSm+" Item AJAX failed"+t)}).catch(function(t){r.error("ERROR: New "+e.conf.msgNameSm+" Item AJAX failed"),a.error("ERROR: New "+e.conf.msgNameSm+" Item AJAX failed",t)})},e.editExpenseItem=function(t){e.itemToEdit=e.items[t],e.removeTrigger.status=!1},e.editExpenseItemSave=function(o){if(""==o.name||!t.isNumber(o.priority))throw r.error("ERROR: "+e.conf.msgNameBg+" expense input check failed"),new Error("ERROR: "+e.conf.msgNameBg+" expense input check failed");_env()._dev&&a.log("Update PROJECT by "+e.conf.msgNameBg+": reason - EDIT "+e.conf.msgNameBg+" EVENT ");var d={_id:e.currentProject._id,key:e.conf.mainProp,keyURL:"/"+e.conf.mainProp+"DataSave"};d[e.conf.mainProp]=e.currentProject[e.conf.mainProp],n._ajaxRequest("PUT",null,d,d.keyURL).then(function(t){e.itemToEdit={},_env()._dev?r.success(e.conf.msgNameBg+" Expense Item Edited!"):r.success("OK")},function(t){throw r.error("ERROR: "+e.conf.msgNameBg+" Expense Item AJAX failed"),new Error("ERROR: "+e.conf.msgNameBg+"Expense Item AJAX failed"+t)}).catch(function(t){r.error("ERROR: "+e.conf.msgNameBg+" Expense Item Edit AJAX failed"),a.error("ERROR: "+e.conf.msgNameBg+" Expense Item Edit AJAX failed",t)})},e.deleteExpenseItem=function(t){e.currentProject[e.conf.mainProp].expCollection.splice(t,1),_env()._dev&&a.log("Update PROJECT by "+e.conf.msgNameBg+": reason - REMOVE "+e.conf.msgNameBg+" EVENT ");var o={_id:e.currentProject._id,key:e.conf.mainProp,keyURL:"/"+e.conf.mainProp+"DataSave"};o[e.conf.mainProp]=e.currentProject[e.conf.mainProp],n._ajaxRequest("PUT",null,o,o.keyURL).then(function(t){e.itemToEdit={},_env()._dev?r.info(e.conf.msgNameBg+" Item removed"):r.info("OK")},function(t){throw r.error("ERROR: "+e.conf.msgNameBg+"  Item AJAX failed"),new Error("ERROR: "+e.conf.msgNameBg+"  Item AJAX failed"+t)}).catch(function(t){r.error("ERROR: "+e.conf.msgNameBg+"  Item Edit AJAX failed"),a.error("ERROR: "+e.conf.msgNameBg+"  Item Edit AJAX failed",t)})}}function r(t,e,a,r,n,o){t.sendSms=function(r){var n=r.author;if(r.text&&r.author){r.date=Date.now();var d={_id:t.currentProject._id,keyFullURL:t.currentProject._id+"/visitorNewSMS",keyURL:"/visitorNewSMS",data:r};o._ajaxRequest("POST",null,d,d.keyFullURL).then(function(){a.success("OK!"),t.sms={},t.sms.author=n}).catch(function(t){a.error("ERROR: AJAX ERROR"),e.error("ERROR: AJAX ERROR",t)})}},t.clearAllSms=function(){t.currentProject.smsCollection.length=0;var r={_id:t.currentProject._id,keyURL:"/sms",data:t.currentProject.smsCollection};o._ajaxRequest("PUT",null,r,r.keyURL).then(function(){a.info("SMS LIST CLEARED!")}).catch(function(t){a.error("ERROR: AJAX ERROR"),e.error("ERROR: AJAX ERROR",t)})}}e.$inject=["$scope","$log","toastr","$window","$timeout","ResourceService","UsersResourceService"],a.$inject=["$scope","$log","toastr","ResourceService"],r.$inject=["$scope","$log","toastr","$http","$timeout","ResourceService"];var n=t.module("budgetCtrlModule",["wedServices","authServices"]);return n.controller("budgetMainCtrl",e),n.controller("tasksMainCtrl",a),n.controller("smsMainCtrl",r),n});