define(["angular"],function(e){"use strict";function r(r,t,n,c,o,s,i,u,a,d){function f(){if(r.currentUser._id&&r.currentUser.isLogged){var e={_id:r.currentUser._id,name:r.currentUser.name,moment:Date.now(),keyURL:"/uOnline"};n({method:"PUT",url:_env()._usersURL+e._id+e.keyURL,data:e}).catch(function(e){u.error("NO SERVER CONNECTION!"),c.log(e)})}}function U(){if(r.currentUser._id&&r.currentUser.isLogged){var e=Date.now();n({method:"GET",url:_env()._usersURL+r.currentUser._id+"/uPing"}).then(function(){r.ping=Date.now()-e}).catch(function(e){u.error("NO SERVER CONNECTION!"),c.log(e)})}}r.currentUser={},r.currentProject={},r.projects=[],r.currentProjectView={},r.toDay=new Date,o.path("/start"),r.ping=0,r.dynamicBackground="start_main",r.newSMS={},r.version="0.6.0",r.versionStatus="beta",r.exitToStart=function(){o.path("/start"),r.dynamicBackground="start_main"},r.goToHomePage=function(){r.currentUser.isAuth?(o.path("/index"),r.dynamicBackground="projects_main",r.decorNames=!1,r.$emit("projectsListChange"),r.currentProjectView.mainMenu=null):r.exitToStart()},r.logOut=function(){r.currentUser.isLogged=!1,r.$broadcast("logout"),s(function(){r.currentUser={},r.currentProject={},r.projects=[],r.currentProjectView={}},200)},r.$on("LoggedIn",function(n,i){r.currentUser=i,r.currentUser.isLogged&&r.currentUser.isAuth?s(function(){function n(){var t={id:r.currentUser._id};a._ajaxRequest("POST",null,t,"/getProjects").then(function(t){r.projects=t,e.forEach(r.projects,function(t){e.forEach(r.currentUser.smsQty,function(e){if(e.projectId==t._id){var n=e.qty,o=t.smsCollection.length;if(n<o&&(r.newSMS[t._id]=o-n),n>o){r.newSMS[t._id]=0,e.qty=o;var s={_id:r.currentUser._id,arr:r.currentUser.smsQty};d._ajaxRequest("PUT",null,s,"/smsQty").catch(function(e){u.error("USER SMS QTY AJAX FAILED!"),c.error("USER SMS QTY AJAX FAILED!",e)})}n==o&&(r.newSMS[t._id]=0)}})})}).catch(function(e){u.error("ERROR: PRO LIST LOAD AJAX failed"),c.warn("ERROR: PRO LIST LOAD AJAX failed",e)})}r.$on("projectsListChange",function(e){n()}),r.editProject=function(e){t.$broadcast("editProject",{id:e})},r.goToSelectedProject=function(e,t){a._ajaxRequest("GET",e,null,null).then(function(e){t?s(function(){r.currentProject=e,o.path("/project"),r.decorNames=!0,r.currentProjectView.mainMenu="budget"},500):(r.currentProject=e,o.path("/project"),r.decorNames=!0,r.currentProjectView.mainMenu="budget")})},r.svrMsgChecked=function(){r.currentUser.serverMSG.splice(0,1);var e={_id:r.currentUser._id,keyURL:"/svrMsgChecked",data:r.currentUser.serverMSG};d._ajaxRequest("PUT",null,e,e.keyURL).then(function(){_env()._dev&&u.success("MSG CHECKED!")}).catch(function(e){u.error("USER SMS QTY AJAX FAILED!"),c.error("USER SMS QTY AJAX FAILED!",e)})}},300):o.path("/start")}),r.$on("AccessApproved",function(e,t){s(function(){r.currentUser.visitor=!0,r.decorNames=!0,r.currentProject=t,o.path("/project"),r.dynamicBackground="projects_main"},200)}),r.$on("smsQty",function(t,n){if(e.isNumber(n.qty)){r.currentUser.smsQty.push(n);var o={_id:r.currentUser._id,arr:r.currentUser.smsQty};d._ajaxRequest("PUT",null,o,"/smsQty").catch(function(e){u.error("USER SMS QTY AJAX FAILED!"),c.error("USER SMS QTY AJAX FAILED!",e)})}if("remove"==n.qty){e.forEach(r.currentUser.smsQty,function(e,r,t){e.projectId==n.projectId&&t.splice(r,1)});var s={_id:r.currentUser._id,arr:r.currentUser.smsQty};d._ajaxRequest("PUT",null,s,"/smsQty").catch(function(e){u.error("USER SMS QTY AJAX FAILED!"),c.error("USER SMS QTY AJAX FAILED!",e)})}}),r.$on("ping",function(e,t){r.ping=t}),r.projectView=function(e){switch(e){case"budget":r.currentProjectView.mainMenu=e,s(function(){r.$broadcast("doBudgetReCalculation")},500);break;case"restaurant":case"arrangement":case"program":case"filming":case"registration":case"marriage":case"transport":case"dress":case"party":case"other":r.currentProjectView.mainMenu=e}},r.svrNotesFilter=function(e){if(null==e)return"";var r=e.split("*");return""==r[0]&&r.splice(0,1),r},r.$on("LoggedIn",function(){r.currentUser._id&&r.currentUser.isLogged&&i(function(){f()},3e5)}),r.$on("LoggedIn",function(){r.currentUser._id&&r.currentUser.isLogged&&i(function(){U()},3e3)})}function t(e){e.currentUser.isAuth&&(e.projectListDateCheck=function(e){return new Date(e.weddingDate).setHours(23,59,0)>Date.now()})}r.$inject=["$scope","$rootScope","$http","$log","$location","$timeout","$interval","toastr","ResourceService","UsersResourceService"],t.$inject=["$scope"];var n=e.module("wedControllers",["wedServices","authServices"]);return n.controller("wedMainCtrl",r),n.controller("wedProjectsMainCtrl",t),n});